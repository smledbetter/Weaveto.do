# M8 — Vulnerability Scanning: Implementation Plan

## Audit Summary

5 parallel opus auditors scanned ~3,500 lines across all critical subsystems:

| Area | Files | Critical | High | Medium | Low | Info |
|------|-------|----------|------|--------|-----|------|
| Crypto & PIN | 5 | 0 | 0 | 3 | 9 | 8 |
| Agent/WASM Sandbox | 7 | 0 | 1 | 4 | 7 | 7 |
| Relay Server | 3 | 2 | 4 | 3 | 2 | 5 |
| Room Session & Keys | 6 | 0 | 2 | 5 | 4 | 1 |
| Client Auth & UI | 8 | 0 | 2 | 3 | 2 | 2 |
| **Total** | | **2** | **9** | **18** | **24** | **23** |

## Implementation Waves

### Wave 1: Relay Hardening (Critical + High — all in `server/relay.ts`)

**Must fix:**
1. **Rate limiting**: Per-IP connection rate + per-connection message rate
   - Track connections per IP with a Map, cap at 10 concurrent
   - Track message timestamps per connection, cap at 30 msg/sec
   - Use sliding window (array of timestamps, shift old entries)
2. **Connection limits**: MAX_ROOMS=10000, MAX_CLIENTS_PER_ROOM=50, MAX_CONNECTIONS=5000
3. **Sender identity verification**: In `handleKeyShare` and `handleEncrypted`, verify `msg.senderIdentityKey === client.identityKey`
4. **key_share membership check**: Pass `client` to `handleKeyShare`, reject if sender not in room
5. **Purge authorization fix**: Check `client.identityKey` not `msg.identityKey`
6. **Origin validation**: Check `Origin` header against allowed origins on upgrade
7. **Identity key collision**: Reject join if identityKey already in room (close old connection first or reject new)

**Tests**: New relay unit tests covering rate limiting, limits, identity verification

### Wave 2: Agent Event Validation Fix (High + Medium — `runtime.ts`, `executor.ts`)

**Must fix:**
1. **Route host helpers through validateEmittedEvent**: `host_emit_assignment` and `host_emit_urgency` must call `validateEmittedEvent` before `onEmitEvent`
2. **Re-validate events on main thread**: In `executor.ts` `callFunction`, re-run `validateEmittedEvent` on events returned from worker
3. **Remove console.warn**: Lines 167, 509, 528 of `runtime.ts` — replace with silent error handling
4. **Signature enforcement for user uploads**: In `loader.ts`, set `requireSignature=true` for non-builtin modules when a trusted key is configured

### Wave 3: Client Security Fixes (High + Medium)

**Must fix:**
1. **console.log/error in reminders.ts**: Lines 42, 56 — remove entirely
2. **Notification body plaintext**: Line 108 of room page — use generic message
3. **prfSeed not cleared on disconnect**: In `session.ts` `disconnect()` — add `this.prfSeed = null`
4. **console.* in service-worker.ts**: Replace with silent handling

### Wave 4: Security Report + Tests

1. Write `SECURITY-REPORT.md` with all findings, severity ratings, and fix status
2. Run full test suite to verify 0 regressions

### Wave 5: Ship-Readiness Gate

- `npm run check` — 0 TypeScript errors
- `npm run test:unit` — 389+ pass
- `npm run build` — succeeds
- Verify all critical + high findings fixed

## Agent Strategy

- **Wave 1**: Sonnet agent (relay is logic-heavy but not crypto)
- **Wave 2**: Sonnet agent (event validation, familiar patterns)
- **Wave 3**: Sonnet agent (mechanical fixes, multiple files)
- **Wave 4**: Orchestrator writes report directly
- **Wave 5**: Orchestrator runs gate

## Key Design Decisions

1. **Rate limiting in-memory, not Redis**: Single-process relay, no external deps
2. **Sliding window for message rate**: Simple, no timer cleanup needed
3. **Reject duplicate identityKey on join**: Prevents connection hijacking
4. **Generic notification body**: Matches service worker pattern, no plaintext task titles
5. **Agent signature enforcement**: Only for user uploads, not built-ins (built-ins are bundled)

# M8 — Vulnerability Scanning: Security Report

**Audit date**: 2026-02-19
**Scope**: All shipped milestones (M0–M7), ~3,500 lines across 29 files
**Method**: 5 parallel opus auditors covering crypto, agents, relay, sessions, and client auth

## Summary

| Severity | Found | Fixed | Deferred | Rationale for Deferral |
|----------|-------|-------|----------|------------------------|
| Critical | 2 | 2 | 0 | — |
| High | 9 | 8 | 1 | No upload UI exists yet |
| Medium | 18 | 8 | 10 | Low impact or no practical fix |
| Low | 24 | 0 | 24 | Informational hardening, no exploit |
| Info | 23 | 0 | 23 | Design notes, no action needed |

---

## Critical Findings

### C-1: Relay — No rate limiting ✅ FIXED
- **File**: `server/relay.ts`
- **Risk**: Any client could flood the relay with messages, causing DoS for all connected users
- **Fix**: Added per-connection message rate limiting (30 msg/sec sliding window). Connections exceeding the limit are closed with code 4029

### C-2: Relay — No connection or room limits ✅ FIXED
- **File**: `server/relay.ts`
- **Risk**: Unbounded room creation and connections could exhaust server memory
- **Fix**: Added `MAX_ROOMS=10,000`, `MAX_CONNECTIONS=5,000`, `MAX_CLIENTS_PER_ROOM=50`, `MAX_CONNECTIONS_PER_IP=10`. Excess connections rejected at upgrade with appropriate HTTP status codes

---

## High Findings

### H-1: Relay — Purge uses self-reported identity ✅ FIXED
- **File**: `server/relay.ts`, `handlePurge()`
- **Risk**: Attacker could forge `msg.identityKey` to match creator and purge any room
- **Fix**: Changed to `client?.identityKey` — uses the connection's registered identity, not the message field

### H-2: Relay — No sender identity verification in key_share ✅ FIXED
- **File**: `server/relay.ts`, `handleKeyShare()`
- **Risk**: Client could send key_share with spoofed `senderIdentityKey`, potentially intercepting Olm session establishment
- **Fix**: Added `if (msg.senderIdentityKey !== client.identityKey) return;`

### H-3: Relay — No sender identity verification in encrypted ✅ FIXED
- **File**: `server/relay.ts`, `handleEncrypted()`
- **Risk**: Client could send encrypted messages with spoofed sender identity
- **Fix**: Added `if (msg.senderIdentityKey !== sender.identityKey) return;`

### H-4: Relay — key_share skips membership check ✅ FIXED
- **File**: `server/relay.ts`, `handleKeyShare()`
- **Risk**: Unauthenticated connection (pre-join) could send key_share messages
- **Fix**: Added `if (!client || !room.clients.has(client.identityKey)) return;`

### H-5: Relay — No origin validation on WebSocket upgrade ✅ FIXED
- **File**: `server/relay.ts`, upgrade handler
- **Risk**: Cross-origin WebSocket hijacking from malicious pages
- **Fix**: Added `ALLOWED_ORIGINS` set check. Non-browser clients (no Origin header) are permitted; browser clients must match `localhost:5173` or `weaveto.do`

### H-6: Relay — Identity key collision allows connection hijacking ✅ FIXED
- **File**: `server/relay.ts`, `handleJoin()`
- **Risk**: Attacker reconnecting with a stolen identity key could hijack an existing session
- **Fix**: On identity key collision, the old connection is explicitly closed before the new one is registered

### H-7: Agent — Signature verification optional by default ⚠️ DEFERRED
- **File**: `src/lib/agents/loader.ts`, `verifyManifestSignature()`
- **Risk**: User-uploaded WASM modules accepted without signature verification when a trusted key is configured
- **Deferral rationale**: No upload UI currently exists. The `verifyManifestSignature()` function accepts `requireSignature=true` and is fully implemented. When the upload UI is built, callers must pass `requireSignature=true` for non-builtin modules
- **Tracking**: Must be enforced when M-future agent upload UI is implemented

### H-8: Client — console.log/console.error in reminders.ts ✅ FIXED
- **File**: `src/lib/tasks/reminders.ts`, lines 42, 56
- **Risk**: Leaks task IDs and error details to browser console, violating security policy
- **Fix**: Removed both calls, replaced with silent error handling

### H-9: Agent — Event validation bypass via host helpers ✅ FIXED
- **File**: `src/lib/agents/runtime.ts`, `host_emit_assignment` and `host_emit_urgency`
- **Risk**: These binary host helpers called `onEmitEvent` directly, bypassing `validateEmittedEvent()`. A malicious WASM module could emit events for non-existent tasks
- **Fix**: Both helpers now route through `validateEmittedEvent()` before `onEmitEvent()`. Invalid events are silently dropped

---

## Medium Findings

### M-1: Agent — Events not re-validated on main thread ✅ FIXED
- **File**: `src/lib/agents/executor.ts`, `callFunction()`
- **Risk**: Events emitted by Worker could be tampered with in transit (defense-in-depth concern)
- **Fix**: Main thread now calls `validateEmittedEvent()` on all events received from Worker before passing to `onEmitEvent()`

### M-2: Agent — console.warn in runtime.ts ✅ FIXED
- **File**: `src/lib/agents/runtime.ts`, lines 167, 509, 528
- **Risk**: Leaks agent module IDs and state operation details to console
- **Fix**: All three `console.warn` calls removed, replaced with silent error handling

### M-3: Client — Notification body contains plaintext task title ✅ FIXED
- **File**: `src/routes/room/[id]/+page.svelte`, line 108
- **Risk**: Browser notification body contained task title in plaintext, visible on lock screen
- **Fix**: Changed to generic message: `"A task is due soon — open Weave to view details"`

### M-4: Client — prfSeed not cleared on disconnect ✅ FIXED
- **File**: `src/lib/room/session.ts`, `disconnect()`
- **Risk**: WebAuthn PRF seed remained in memory after disconnecting from a room
- **Fix**: Added `this.prfSeed = null;` (plus `identityKey` and `ed25519Key` clearing) to `disconnect()`

### M-5: Client — console.* in service-worker.ts ✅ FIXED
- **File**: `src/service-worker.ts`, multiple locations
- **Risk**: Error details leaked to console in service worker context
- **Fix**: All `console.error` and `console.warn` calls removed, replaced with silent handling

### M-6: Agent — console.warn in runtime.ts state size check ✅ FIXED
- **File**: `src/lib/agents/runtime.ts`, line 167
- **Risk**: Leaks module ID and state size to console when state exceeds limit
- **Fix**: Removed `console.warn`, the function already returns early (no-op)

### M-7: Client — reminderNotice still shows plaintext in-page ⚠️ DEFERRED
- **File**: `src/routes/room/[id]/+page.svelte`, line 107
- **Risk**: The in-page `reminderNotice` variable still contains the task title. This is intentional — the user is already viewing the room page and has access to all task data
- **Deferral rationale**: In-page display is not a leak — the user has already decrypted all room content

### M-8: Crypto — JavaScript GC cannot zero sensitive memory ⚠️ DEFERRED
- **Risk**: Cryptographic key material in JavaScript variables cannot be reliably zeroed
- **Deferral rationale**: No practical fix in JavaScript. This is a known platform limitation. WASM memory is zeroed on module teardown

### M-9: Crypto — PRF salt is static per credential ⚠️ DEFERRED
- **Risk**: WebAuthn PRF extension uses a static salt
- **Deferral rationale**: WebAuthn spec mandates per-credential isolation. The salt is fixed by design — each credential produces a unique PRF output regardless

### M-10: Crypto — No server-side WebAuthn challenge verification ⚠️ DEFERRED
- **Risk**: WebAuthn challenges are generated and verified client-side only
- **Deferral rationale**: No server by design. WebAuthn is used for key derivation (PRF), not authentication. The threat model assumes the client is trusted for its own key material

### M-11: Relay — No TLS termination ⚠️ DEFERRED
- **Risk**: Relay serves plaintext WebSocket without TLS
- **Deferral rationale**: Deployment-specific. Production deployments use reverse proxy (Caddy/nginx) for TLS. All message payloads are E2E encrypted regardless

### M-12: Relay — HTTP handler returns server info ✅ FIXED
- **File**: `server/relay.ts`, HTTP handler
- **Risk**: Default HTTP response revealed server identity and description
- **Fix**: Changed to minimal `res.writeHead(200); res.end("OK");`

### M-13–M-18: Various low-impact medium findings ⚠️ DEFERRED
- HKDF info strings are short but unique per context (acceptable)
- AES-GCM nonce reuse is prevented by random IV generation (verified correct)
- Megolm ratchet state not explicitly verified (vodozemac handles internally)
- Agent memory bounds rely on WASM spec (no custom bounds checking needed)
- Circuit breaker threshold is configurable but defaults are reasonable
- Task event timestamps use `Date.now()` (adequate for conflict resolution)

---

## Low Findings (24 total) — All Deferred

Low findings are informational and do not represent exploitable vulnerabilities. Categories:

- **Defensive coding** (8): Missing `finally` blocks, unchecked return values, implicit type coercions
- **Error handling** (6): Catch blocks that swallow errors without logging (intentional per security policy)
- **Memory** (4): Large buffers not explicitly freed (GC handles this adequately)
- **Naming** (3): Inconsistent naming conventions across files
- **Documentation** (3): Missing JSDoc on internal functions

---

## Info Findings (23 total) — No Action Required

Informational notes about design decisions, not vulnerabilities:

- Olm session management follows vodozemac reference patterns
- PBKDF2 iteration count (600K) meets OWASP 2024 recommendations
- HKDF-SHA256 usage is correct (extract-then-expand)
- WebAuthn PRF flow matches W3C spec
- Event-sourced task store has natural idempotency
- Agent WASM sandbox relies on WebAssembly spec guarantees (memory isolation, no syscalls)
- Service worker notification pattern correctly avoids plaintext in push payloads

---

## Recommendations for Future Milestones

1. **M-future (Agent Upload UI)**: When implemented, `verifyManifestSignature()` must be called with `requireSignature=true` for all non-builtin modules
2. **M9 (Notifications)**: Web Push payloads must remain generic (no task content) — current service worker pattern is correct
3. **M10 (Offline)**: IndexedDB encryption at rest must use per-room keys derived from the room's HKDF context
4. **Ongoing**: Maintain zero `console.*` policy in client code — enforced via code review
